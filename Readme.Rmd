---
title: Identifying covariate traits of trance and possession phenomena in the Ethnographic
  Atlas using boosting and nested regression
author: "Péter Rácz"
date: "`r format(Sys.Date(),'%e %B, %Y')`"
output:
  md_document:
    variant: markdown_github
bibliography: bibliography.bib
---

# To do: one-hot encoding ended up creating unidentifiable vars (where both values of a col are present) so do something with that.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, fig.path = 'figures/', fig.width = 8, fig.height = 8)
```

```{r header}
setwd('~/Github/Racz2023trance/')

library(tidyverse)
library(glue)
library(knitr)
library(patchwork)

ld = read_tsv('data/dat_long.tsv')
wd = read_tsv('data/dat_wide.tsv')
sccs = filter(ld, in_sccs)
```

We want to look at two questions. What sort of social factors have been proposed to co-occur with trance and possession phenomena? Using the Ethnographic Atlas and the Standard Cross-Cultural Sample, can we get more confident that these factors do co-occur with such phenomena across cultures?

## 1. Trance and possession phenomena have societal covariates in the literature

Many people have argued that trance induced by possession is not a random, idiosyncratic pathology but a recurrent psycho-social trait that is at least partly motivated by other social factors. 

High overall social complexity and social rigidity -- the resulting power dynamics -- might translate to possession trance practices. Such practices might serve to express or relay perceived social inflexibility and inequality. This is echoed in the medical anthropology literature (@during2011critical,@dein2012religion) and ties in with broader questions of inequality and mental health (@nguyen2003anthropology). Various causative models have been proposed to account for the emergence of possession trance and, specifically, shamanism in a social setting (@winkelman2015shamanism, @singh2018cultural, @wood2018trance).

Some or most groups can feel stuck in a society. If this makes trance and possession more likely, we should see correlations between measures of social complexity, organisation, and inequality and possession and trance in cross-cultural data. Many such correlations have been proposed by previous work. Here is a list, cross-referenced with @wood2018complexity:

| Relationship                                                                             | Reference                |
|:-----------------------------------|:-----------------------------------|
| Social complexity, rigidity, gender role differentiation                                    | @bourguignon1968         |
| Women's social participation                                                             | @bourguignon1973religion |
| Slavery, role differentiation, and structure differentiation | @greenbaum1973           |
| Increased social participation                                | @swanson1978             |
| Social complexity                                     | @winkelman1986           |
| Social flexibility, cognatic kinship                              | @shaara1992              |
| Decreased social participation                                | @douglas2004natural      |
| Social rigidity, monotheism                                                                               | @wood2018complexity      |

Several works made the same point or emphasised various aspects of the same relationship. The above table is somewhat reductive.

## 2. This can be mapped to the Ethnographic Atlas

The use of cross-cultural typological data in general and the Ethnographic Atlas in particular has precedents. @bourguignon1968, @bourguignon1973religion, and @greenbaum1973 use the Ethnographic Atlas to look for correlates of trance and possession trance. @wood2018complexity, @shaara1992, @winkelman1986, and @douglas2004natural build on this research by specifying and compiling their own data sets. The present paper uses the Ethnographic Atlas as made available in the D-Place database, @kirby2016d.

The Atlas records the presence of trance and possession phenomena in a given society, using the following variable (EA112):

```{r }
trance = sccs %>% 
  filter(var_id == 'EA112') %>% 
  count(var_name,code,var_description) %>% 
  rename(name = var_name, description = var_description, "n in SCCS" = n) %>% 
  mutate(
    possession_trance = case_when(
      code %in% c(3,4,6,7) ~ 'possession trance',
      code %in% c(1,2,8,5) ~ 'other'
    ) %>% 
      fct_relevel('possession trance')
  )

ld %>% 
  filter(var_title == 'Trance states', !is.na(code)) %>% 
  count(code, var_description, name = 'n in EA') %>% 
  left_join(trance) %>% 
  arrange(code) %>% 
  rename(Coding = code, Description = var_description) %>% 
  select(Coding,Description,possession_trance,`n in EA`,`n in SCCS`) %>% 
  kable('simple')
```

This is basically a truth table of whether possession beliefs or trance states are present in a given society, with some causal links between the two (if possession happens it leads to trance, if trance happens it's because of possession, etc). We can think of different groupings (trance phenomena encompass levels 1,3,4,5,6,7, possession phenomena encompass 2,3,4,5,6,7, specifically possession trance covers 3,4,6,7 but not 1,2,5,8).

The Atlas lists a set of variables that tie in with the observed covariates in the literature. These are either taken literally from @bourguignon1968, @bourguignon1973religion, and @greenbaum1973 or adapt variables used by @wood2018complexity, @shaara1992, @winkelman1986, and @douglas2004natural.

```{r }
ld %>% 
  filter(var_title != 'Trance states') %>% 
  distinct(var_id,var_title,var_definition) %>%
  arrange(var_id) %>% 
  rename(ID = var_id, Name = var_title, Definition = var_definition) %>% 
  kable('simple')
```

## 3. How do we look for correlations between trance and possession and their proposed societal covariates?

There are eight types of trance and possession phenomena recorded in the Atlas and a wide set of possible covariates, all with a number of levels (see the Appendix).

The data are challenging in two ways. The variables are themselves correlated, either because they measure different facets of the same thing (like how complex a society is; see the figure below) or because they were adapted together by socially or geographically close societies (Galton's problem). In addition, data are missing from the Atlas in a non-random manner (e.g. if a society is hard to access, it is harder to provide a population size estimate for it).

```{r }
cord = wd %>% 
  filter(in_sccs) %>% 
  select(-outcome,-EA112_Trance_states,-trance_present,-possession_present,-possession_trance_present,-soc_id,-in_sccs) %>% 
  mutate_if(is.logical, as.double)

cor(cord,use="pairwise.complete.obs")


```

We can account for Galton's problem (geographic and cultural co-variation) by restricting our initial data to societies in the Standard Cross-Cultural Sample.

The remaining co-variation and the non-random patterns of missing data recommends an ensemble learning method. This starts with societies with information on trance and possession phenomena and builds a lot of tiny models, using random samples of the data and random subsets of the covariates. Then, we compare these models to assess the overall importance of our covariates. Building little models in parallel is called bagging. This is how a random forest works, growing many classification or regression trees and aggregating over the results. One step further is to train models on the mistakes of the previous models. This is called [boosting](https://www.ibm.com/cloud/learn/boosting) and usually results in higher training and prediction accuracy.

## 4. Building a boosting model

In this analysis, we will use a gradient boosting model on the data from the Ethnographic Atlas, subsetting it to only include societies in the Standard Cross-Cultural Sample.

Gradient boosting is an ensemble learning method which uses decision trees. A decision tree is a directed tree graph in which each node represents a decision or split based on a predictor variable and each leaf is an individual data point. It can be used to classify leaves by grouping them under different node structures. A gradient boosting algorithm fits such trees in a sequence, training each on the errors of the previous one, minimising overall error. It stops when further iterations do not result in meaningful improvement on model accuracy (according to pre-set criteria) [@cook2016practical,@rhys2020machine,@smith2017decision].

We only fit the model on societies which (a) have information on whether trance and possession phenomena are present and (b) come from the standard cross-cultural sample.

Following @bourguignon1968, we reduce the complexity of the outcome variable to two levels: whether a society has possession trance or not. The predictors are the possible covariates identified above. Some predictors, like `EA032` (Jurisdictional hierarchy of local community) or `EA113` can be construed to follow a scale. These are input as ordered factors. Others, like `EA053` (Sex differences in animal husbandry) or `EA043` (Major type of descent) can be carved up into categories: These are one-hot encoded. For details, see the Appendix.

We use hyperparameter tuning to find the best possible model.  The model is fit on a training set of `length(unique(sccs$soc_id))` societies with information on trance and possession in the standard cross-cultural sample.

## 5. Results on the training sample

Looking back at the table in the previous section, we see that only about 10% of societies have no trance or possession phenomena. From the rest, a majority have possession trance in some form. Following @bourguignon1968 we can reduce this to a binary: 81 societies have possession trance, 70 have other forms of trance and possessior or show neither.

```{r }
trance %>% 
  group_by(possession_trance) %>% 
  summarise(count = sum(`n in SCCS`)) %>% 
  kable('simple')
```

We compare this with how our best model categorises each society. This is our model's confusion matrix. `0` is absence of possession trance, `1` is presence of possession trance. The rows add up to values in the original, the columns are the model's predictions. The last two columns show the error rate. The model's accuracy on absence of possession trance is relatively low, though higher than chance (54 out of 80, p < 0.01 using a binomial test with a true p of .529). It is mostly accurate capturing the presence of possession trance.

```{r }
cm1a = read_tsv('models/conf_matrix11model.tsv')
cm1a %>% 
  mutate(original = c(names(cm1a)[!names(cm1a) %in% c('Error','Rate')],'Total')) %>% 
  relocate(original) %>% 
  kable('simple', digits = 2)

# precision = true 1/false 1
# recall = true 1/true1 + false0
precision = 68 / 94
recall = 68 / 71
f = (2 * precision * recall) / (precision + recall)
```

The model has an F-measure of `r round(f,2)`, with a penalty on overgeneralising possession trance. Though comparisons are hard to make, this is not particularly accurate for a binary categorisation problem. We did expect this, though, as it is unlikely that any complex cultural phenomenon could be reduced to a small number of cross-cultural predictors.

### 6. Results on the EA data

We can ask the model to make predictions for the entire Ethnographic Atlas (where trance and possession data are available) -- including the SCCS subset. Generally, you want to separate the training and test sets in Machine Learning and not do this, but the 'everything except the SCCS' subset of the Atlas would be an odd test set.

Here is the confusion matrix for all `r length(unique(ld$soc_id))` societies in the Atlas where trance and possession information are available:

```{r }
cm1b = read_tsv('models/conf_matrix11test.tsv')

cm1b %>% 
  kable('simple')

# precision = true 1/false 1
# recall = true 1/true1 + false0
precision2 = 221 / 389
recall2 = 221 / 281
f2 = (2 * precision2 * recall2) / (precision2 + recall2)

```

The F-measue of this model is `r round(f2,2)`. Accuracy here is much worse than for the training data only. That is at least partly because the model is ignorant of the phylogenetic signal which might result in patterns that are unexpected from a purely correlational point of view. However, the model is still more accurate than it would be by chance.

We take a look at the variables that were most important in the model in predicting the presence of possession trance in a given society, with a cutoff of 10/47. 

```{r }
vars = ld %>% 
  filter(var_title != 'Trance states') %>% 
  distinct(var_id,var_title,var_definition,var_name) %>%
  arrange(var_id) %>% 
  group_by(var_id, var_title, var_definition) %>% 
  nest() %>% 
  mutate(levels = map(data, ~ paste(.$var_name, collapse = ', '))) %>% 
  select(var_id, var_title, levels) %>% 
  unnest(cols = c(levels)) %>% 
  rename(ID = var_id, Name = var_title)

varimp1 = read_tsv('models/varimp11.tsv')
vars2 = varimp1 %>% 
  slice(1:10) %>% 
  mutate(ID = str_extract(variable, '^EA...')) %>% 
  left_join(vars, by = "ID") %>% 
  select(ID, Name, relative_importance)
  
vars2 %>% kable(digits = 2, 'simple')
```

We now look at the direction of these effects (does e.g.\ increased jurisdictional hierarchy go with more or less prevalent possession trance?).

The figure below shows the proportion of societies with possession trance (dark blue) and without (light blue) across the ordered levels of the predictors that the model thinks are important. They come in order of how important they are, according to the model; prevalence of slavery, then family organisation, and so on. The predictor levels are ordered according to coding and generally go from less prevalent (top) to more prevalent (bottom):

For the most important variables, we see a clear correllation between the presence of possession trance and the variable scaling up. Societies in which slavery is more prevalent have more possession trance than those where it is less prevalent. Same is true for societies with more complex family structures, more social complexity, more complex settlement patterns, and larger settlements. The societal variables that do not, strictly speaking, measure social organisation are less obvious.

```{r fig.width=10,fig.height=15}
d_out = ld %>% 
  filter(var_id == 'EA112') %>% 
  mutate(
    possession_trance_present = case_when(
      code %in% c(3,4,6,7) ~ 'present',
      code %in% c(1,2,5,8) ~ 'absent'
        )
      ) %>% 
  select(soc_id,possession_trance_present)

d_in = ld %>%
  filter(var_title %in% vars2$Name, !is.na(code)) %>% 
  mutate(
    predictor = fct_reorder(var_name, -as.double(recoded_value)),
    var_title = fct_relevel(var_title, vars2$Name)
    ) %>% 
  select(soc_id,var_definition,var_title,predictor)

d_vis = inner_join(d_in,d_out, by = 'soc_id')

plots = d_vis %>%
  count(var_title,predictor,possession_trance_present) %>% 
  # pivot_wider(names_from = possession_trance_present, values_from = n, values_fill = 0) %>% 
  # mutate(log_odds_pt = log((`TRUE` + 1) / (`FALSE` + 1)) ) %>% 
  group_by(var_title) %>% 
  nest() %>% 
  mutate(
    plot = map2(var_title, data, ~ ggplot(.y, aes(predictor,n,fill = possession_trance_present)) +
                  geom_col(position = 'dodge') +
                  theme_bw() +
                  theme(axis.title=element_blank()) +
                  guides(fill = 'none') +
                  scale_fill_brewer(palette = "Paired") +
                  ggtitle(str_wrap(.x, width = 25)) +
                  coord_flip()
                 )
  ) %>% 
  pull(plot)
  
wrap_plots(plots, ncol = 2) + plot_annotation(caption = 'Dark blue: possession trance present. Light blue: absent.')
```

## 7. Summary

These results go some way in confirming hypotheses on the cross-cultural correlates of possession trance in the literature. @bourguignon1968 explicitly tests the variables of slavery, jurisdictional hierarchy, settlement patterns, and kin groups. @shaara1992 point to a high value placed on female virginity at marriage, captured here by norms of premarital sexual behaviour for girls. These are all important variables in our model. @greenbaum1973 and @shaara1992 point to sexual division of labour, while @wood2018complexity to the role of moralising high gods, neither of which is relevant in our model.

This brings us back to the original predictions in the table above.

| Relationship|Reference|Our model|
|:-|:-|:-|
|less complexity$\rightarrow{}$trance w/o possession|@bourguignon1968|the same measures of complexity are relevant|
|women's social participation|@bourguignon1973religion|labour divisions are not relevant|
|increased role differentiation and slavery practices$\rightarrow$trance and possession|@greenbaum1973|slavery, social and class complexity are relevant|
|main mode of subsistence|@bourgouignon1977|not relevant|
|increased social participation$\rightarrow{}$possession|@swanson1978|indirectly, through domestic and social complexity|
|more complexity$\rightarrow{}$trance w/ possession|@winkelman1986|yes, see above|
|cognatic kinship$\rightarrow{}$more possession and trance|@shaara1992|not directly, but kinship structure is relevant|
|decreased social participation$\rightarrow{}$possession|@douglas2004natural|yes, see above|
|monotheism|@wood2018complexity|not relevant in our model|

We can predict some types of trance and possession phenomena in the SCCS subset of the EA. Not all of them. Some of the important co-variates are the ones mentioned by earlier work and the direction of the relationships corroborates the literature.

Human society is complicated and cross-cultural data have very low resolution. In this sense, we'd be very suspect of a model that would be too accurate of predicting possession trance from societal covariates. It cannot replace fieldwork and more complex explanatory models either. What it can do is provide an extra leg for such explanatory work, which is broadly the recognised ambition of cross-cultural comparative work in evolutionary anthropology.

Our approach is statistically strict, so the fact that it still shows some accuracy is definitely promising for the validity of the connections drawn by previous work on trance and possession phenomena in particular and large cross-cultural comparisons in general.

## Appendix

### Relevant predictors in the Ethnographic Atlas

A survey of the literature resulted in the following predictors of trance and possession phenomena.

```{r }
kable(vars, 'simple')
```

### Recoded values in the Ethnographic Atlas

The recoded values were used in the model for each predictor. Where the recoded values are numeric, the predictor was used as an ordered factor. Where the recoded values are strings, the predictor was one-hot encoded (such that predictor A with levels 1, 2, and 3 was turned into boolean predictors A==2 and A==3).

```{r }
ld %>% 
  filter(var_id != 'EA112') %>% 
  distinct(var_id,var_title,var_description,recoded_value) %>% 
  arrange(var_id,recoded_value) %>% 
  kable('simple')
```

## References
